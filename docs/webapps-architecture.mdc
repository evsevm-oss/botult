## Telegram Web Apps (архитектура)

### Поток аутентификации
1) Telegram Mini App загружается внутри клиента Telegram → `initData`
2) Бэкенд валидирует подпись `initData` (секрет бота), извлекает `user`/`chat`/`start_param`
3) Выдаёт короткоживущий токен WebApp (JWT) → используется для REST/WS запросов

### Клиент
- React/Vite (или Next) → рендер страниц дневника/профиля/графиков. Макет реализован в `webapp/new_webapp/telegram_web_app_main.jsx` (план: перенос на TypeScript `.tsx`).
- Хранение состояния в LocalStorage/IndexedDB, синхронизация с API бэкенда. Отображение скелетонов, офлайн‑режим и обработка ошибок.
- Основные виджеты: верхние KPI плитки (цель, калории, протеин, вес, % жира), график веса/% жира с периодами (неделя/месяц/квартал/год), потребление калорий/протеина, дневник с CRUD и навигацией по датам.

### Серверные эндпоинты (минимум)
- `GET /api/me/summary` — дневные бюджеты и сводка
- `POST /api/meals` — создать приём пищи (текст/фото)
- `GET /api/meals?date=YYYY-MM-DD` — список приемов за день

### Эндпоинты для отчётов/трендов (интеграция WebApp)
- `GET /api/summary/daily|weekly|monthly`
- `GET /api/trends?window=7|30` (ккал/БЖУ/вес)
- `GET /api/compliance?range=week|month`
- `GET /api/alerts` (пропуски/выбросы/нуджи)
- `GET /api/summary/weekly.csv` (экспорт)

### Auth WebApp (детали)
- `POST /api/webapp/verify` — валидирует `initData`, возвращает JWT (ttl ~ 30–60 минут)
- Хранение токена на клиенте; обновление по 401; logout стирает токен из LocalStorage

### Хостинг и деплой WebApp
- Сборка фронтенда: `npm ci && npm run build` → `dist/`
- Раздача статики: FastAPI `StaticFiles` по `/webapp/` или прокси через Nginx (CSP, gzip, cache headers)
- Версионирование ассетов (hash) и корректные пути для Telegram клиента

### Навигация из бота
- Кнопка `web_app` и deeplink из сообщений/рассылок (CTA), поддержка `start_param`

### Безопасность
- Проверка подписи `initData`, ограничение CORS, короткие TTL токена, ограничение происхождения загрузки (Telegram)
- Защита от XSS (CSP), отрисовка данных только после верификации токена

