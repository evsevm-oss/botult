## Roadmap: Телеграм-бот подсчета калорий по фото с AI-диетологом

> Важное: каноническая визуализация персонажа закреплена в `character/character_bot.png` и используется во всех документах/макетах/медиа.

Цель: создать бота, который помогает пользователю достигать целей по весу/жиру за счет подсчета калорий и макронутриентов, включая ввод по фото, и персональных рекомендаций AI-диетолога. На этом этапе исключаем продовый деплой и авто‑тесты, но допускаем ручные проверки на выделенном VPS (Debian 12, OVHcloud).

### Стратегические цели
- [ ] Надежный ввод рациона: текст и фото-распознавание (через GPT, без базы продуктов)
- [ ] Точные расчеты TDEE/BMR, дневных бюджетов и БЖУ под цели веса/жира
- [ ] Персональные рекомендации от AI-диетолога в контексте профиля и истории
- [ ] Прогресс: ежедневные/недельные сводки, графики веса/калорий/БЖУ
- [ ] Конфиденциальность и контроль данных пользователя
- [ ] Встроенные Telegram Web Apps для сложных интерфейсов (формы, дневник, графики)
- [ ] Контент: тексты, изображения, видео; персонализированные рассылки и сценарии взаимодействия

### Границы этапа
- [ ] В эту дорожную карту не входят: авто-тесты, CI/CD, продовый деплой

---

## Этап 0. Подготовка проекта
- [x] Сформулировать целевую аудиторию и ключевые сценарии (похудение, набор, поддержание) — см. `docs/audience-and-scenarios.mdc`
- [x] Уточнить ограничения и риски (стоимость LLM/vision, качество распознавания по фото) — см. `docs/risks-and-constraints.mdc`
- [x] Выбрать стек: Python 3.11+, Telegram Bot API (aiogram), FastAPI (внутренние сервисы), PostgreSQL, SQLAlchemy, Alembic, Redis (сессии/кэш), объектное хранилище для изображений (локально/минIO/S3), очередь задач (Celery/RQ) — см. `docs/stack.mdc`
- [x] Выбрать провайдеры AI: мультимодели (GPT-4o/Claude 3.5 Vision/Gemini 1.5); не использовать внешние пищевые базы (оценка нутриентов через GPT) — см. `docs/ai-providers.mdc`
- [x] Создать репозиторий и базовую структуру каталогов (бот, домен, сервисы, инфраструктура, миграции, данные)
- [x] Подготовить `.env.example` и схему конфигурации (секреты ключей Telegram/LLM/БД)
- [x] Описать глоссарий терминов (TDEE, BMR, БЖУ, прием пищи, порция, дневник) — см. `docs/glossary.mdc`
- [x] Разработать брендинг: логотип для аватарки Telegram (палитра, светлая/темная версии), экспорт ассетов (SVG/PNG 640×640/512×512/200×200) и размещение в `data/brand/` — см. `docs/brand-guide.mdc`


## Этап 1. Архитектура системы
- [x] Спроектировать компоненты: бот-обработчики, доменный слой, сервисы интеграций, слой данных — см. `docs/architecture.mdc`
- [x] Диаграмма потоков: пользователь → бот → доменные кейсы → БД/кэш → AI/vision → нормализация (через GPT, без пищевых баз) → ответ — см. `docs/architecture.mdc`
- [x] Определить границы модулей и зависимости (чистая архитектура/портно-адаптерный подход) — см. `docs/architecture.mdc`
- [x] Определить форматы контрактов: DTO/события/ошибки — см. `docs/contracts.mdc`
- [x] Архитектура Telegram Web Apps: фронтенд (React/Vite/Next), верификация `initData`, авторизация и обмен токенами, обмен данными (REST/WebSocket) — см. `docs/webapps-architecture.mdc`

## Этап 2. Модель данных и хранилища
- [x] ER-таблицы (минимум MVP): `users`, `profiles`, `weights`, `meals`, `meal_items`, `images`, `vision_inferences`, `llm_inferences`, `daily_summaries` — см. `infra/db/models.py`
- [x] Миграции стартовой схемы: `alembic/versions/0001_init_schema.py`
- [x] Аудит запросов AI: `llm_inferences` и `vision_inferences`; в `meal_items` хранится снимок нутриентов и единиц на момент ввода

## Этап 3. Базовые доменные расчеты
- [x] Реализовать формулы BMR (Mifflin–St Jeor, Katch–McArdle при наличии % жира) — см. `domain/calculations.py`
- [x] TDEE по уровню активности, дефицит/профицит под цель (темп изменения веса) — см. `domain/calculations.py`
- [x] Конвертация цели по % жира в целевой вес (оценка без/с учетом LBM) — см. `domain/calculations.py`
- [x] Распределение БЖУ (по умолчанию: белок г/кг LBM, жир %, углеводы остаток) — см. `domain/calculations.py`
- [x] Пересчет дневных бюджетов при изменениях профиля/веса/целей — `domain/use_cases/recalculate_daily_budgets.py`, REST `POST /api/recalculate`

## Этап 4. Каркас Telegram-бота
- [x] Подключение к Telegram Bot API, поллинг для локального запуска — см. `bot/main.py`
- [x] Базовые команды: `/start`, `/help`, `/profile`, `/addmeal`, `/photo`, `/coach`, `/stats`, `/settings` — см. `bot/routers/*`
- [x] Стейт‑машина диалогов (заготовка для `/addmeal`), middlewares (логирование, trace‑id, locale=RU) — см. `bot/middlewares/*`
- [x] Локализация (RU как дефолт) — текущие тексты RU, i18n добавим позже
- [x] Встроенные Web Apps: кнопка `web_app` при наличии `WEBAPP_URL` — см. `bot/keyboards.py`
- [x] Проверка `initData` WebApp на сервере — `POST /api/webapp/verify`


## Этап 5. Онбординг и профиль
- [ ] Сбор: пол, дата рождения/возраст, рост, вес, уровень активности, цель (снижение/набор/поддержание), предпочтения (вегетарианство и т.п.), % жира (опционально)
- [ ] Сохранение профиля, первичный расчет бюджетов (калории и БЖУ)
- [ ] Экран/сообщение подтверждения профиля и бюджетов
 - [ ] REST: GET/POST `/api/profile`
 - [ ] WebApp: каркас страницы профиля (форма/просмотр)

## Этап 6. Цели и дневные бюджеты
- [ ] CRUD целей (изменение темпа, целевого веса/% жира)
- [ ] Планирование недельного дефицита/профицита и дневных лимитов
- [ ] Автообновление бюджетов при изменении веса/активности

## Этап 7. Нормализация блюд и нутриентные оценки через GPT
- [ ] Дизайн промптов и few-shot примеров для извлечения блюд, порций и нутриентов
- [ ] Единый JSON-формат ответа: название, категория, масса/объем, калории, БЖУ, степень уверенности, допущения
- [ ] Нормализация единиц и порций (граммы/мл/штуки), калибровка типовых размеров
- [ ] Обработка неопределенности: запрос уточнений у пользователя, варианты выбора
- [ ] Кэширование результатов и частых блюд; пресеты пользовательских блюд

## Этап 8. Ввод еды вручную (MVP дневника)
- [ ] Команда/кнопка «Добавить прием пищи» (завтрак/обед/ужин/перекус)
- [ ] Парсер текстового ввода вида: «куриная грудка 150 г, рис 120 г, масло 5 г»
- [ ] LLM-разбор и автооценка нутриентов; выбор порции, ручная корректировка, подтверждение
- [ ] Запись `meal` и `meal_items` в дневник, обновление `daily_summary`
- [ ] REST: GET/POST `/api/meals` (дневник)
- [ ] WebApp: каркас дневника (список приемов, добавление/редактирование)
- [ ] Редактирование/удаление позиций, повтор предыдущих приемов, избранное
 - [ ] Опционально: ввод и редактирование через Web App формы (тонкие UI для сложных блюд)

## Этап 9. Фото-логирование приемов пищи
- [ ] Прием фото/альбомов, привязка к приему пищи и времени
- [ ] Предобработка изображений: ресайз, компрессия, безопасный контент-фильтр
- [ ] Вызов мультимодели (vision) с системным промптом для распознавания блюд и приблизительных порций
- [ ] Нормализация распознанных блюд через GPT (без базы продуктов), разбиение сложных блюд на компоненты
- [ ] Оценка порций по эвристикам (посуда, «ладонь/кулак», стандартные размеры), возможность ручной корректировки
- [ ] Диалог подтверждения: список блюд → выбор/корректировка → сохранение в дневник
- [ ] Фолбэк на ручной ввод, если распознавание недостаточно уверенное

## Этап 10. AI-диетолог (персональные рекомендации)
- [ ] Разработать персонажа бота (визуальный образ/маскот) и тон коммуникации; отразить логотип в образе; обновить системные промпты/персону
  - Примечание: базовым референсом служит `character/character_bot.png`; любые новые рендеры/аватары должны соответствовать этому образу.
- [ ] Режим чата с контекстом: профиль, цели, бюджеты, история последних дней
- [ ] Инструменты действий из чата: «предложить рацион на день/неделю», «оценить прием», «замены под бюджет», «список покупок»
- [ ] Кнопки-экшены из ответов AI: «внести блюдо», «поменять цель», «создать план на завтра»
- [ ] Гайдлайны безопасности: избегать медицинских диагнозов, уважать ограничения пользователя
- [ ] Генерация контента: персонализированные текстовые шаблоны и сценарии коротких видео (скрипт → субтитры → аудио/озвучка)
- [ ] CTA и интерактив: кнопки для перехода в Web App/добавления блюд/настроек

## Этап 11. Прогресс и отчеты
- [ ] Ежедневная сводка: остаток калорий/БЖУ, баланс дня, рекомендации
- [ ] Недельный отчет: тренды веса/калорий/БЖУ, комплаенс к плану
- [ ] Графики и мини-дашборды (инлайн-изображения/эмодзи-барчарты)
- [ ] WebApp: каркас прогресса (графики/сводки)
- [ ] Напоминания о взвешиваниях и приемах пищи (по желанию пользователя)
- [ ] Форматы контента: карусели медиа, длинные сообщения с разделителями, короткие видео-дайджесты

## Этап 12. Настройки и персонализация
- [ ] Единицы измерения (кг/фунты, мл/унции), предпочтения кухонь/продуктов
- [ ] Времена приемов пищи, частота уведомлений, часовой пояс
- [ ] Избранные блюда/рецепты, пользовательские блюда (композиции)
- [ ] Экспорт/импорт данных пользователя (JSON/CSV)
- [ ] Настройки рассылок: частота, часы, типы контента, opt-in/out на видео

## Этап 13. Качество данных и наблюдаемость (без тестов)
- [ ] Структурированное логирование и корреляция запросов (trace id)
- [ ] Метрики ключевых операций: скорость распознавания, доля подтвержденных пользователем распознаваний, средняя ошибка по калориям/БЖУ
- [ ] Аудит изменений дневника и профиля (кто/когда/что)
- [ ] Регулярная очистка устаревших медиа/временных артефактов
- [ ] Метрики контента: open rate, CTR по кнопкам, досматриваемость видео, отписки

## Этап 14. Производительность и стоимость
- [ ] Кэширование ответов LLM/vision на одинаковые фото/запросы (с дедупликацией)
- [ ] Ограничение размеров изображений и количества вызовов к провайдеру
- [ ] Перенос тяжелых задач (распознавание/нормализация) в очередь, ленивые ответы в чат
- [ ] Транскодирование видео (FFmpeg), ограничение длительности/размера, прогрессивная отправка; хранение в объектном хранилище/кэш

## Этап 15. Документация разработчика
- [ ] README: запуск локально, структура каталогов, переменные окружения
- [ ] Диаграммы: архитектура, ERD, основные последовательности (onboarding, добавление еды, фото-логирование)
- [ ] Примеры сообщений/шаблонов и команд бота

## Этап 16. Готовность к продукту (без деплоя/тестов)
- [ ] Полный сценарий «первый день»: онбординг → расчет бюджетов → добавление еды (вручную/по фото) → сводка дня → советы AI
- [ ] Проверка UX-углов: пустые состояния, отмены, ошибки провайдеров, долгие операции (индикация ожидания)
- [ ] Справка/FAQ в боте, дисклеймер по медицинским ограничениям

## Этап 17. Контент: сообщения, видео и рассылки
- [ ] Контентная матрица: онбординг, обучение, рецепты, мотивация, отчеты, промо
- [ ] Библиотека шаблонов: текст/изображение/видео; переменные персонализации, i18n
- [ ] Создание видео: пайплайн «скрипт → раскадровка/изображения → субтитры → озвучка → рендер → отправка»
- [ ] Структура отправки: сегментация, планировщик, rate limits, приоритеты, отложенные/повторные сообщения, отмена
- [ ] Каналы доставки: личные сообщения (текст/медиа/видео/медиагруппы), Web App страницы/ссылки
- [ ] Согласия и соответствие: Telegram антиспам, opt-in/out, управление отписками
- [ ] Хранилище контента и аналитика эффективности

## Этап 18. Брендинг: дизайн-система
- [ ] Внедрить дизайн-систему для Web App: палитра, типографика, компоненты, иконки, радиусы и отступы
- [ ] Обновить шаблоны сообщений и клавиатуры бота под стиль бренда
- [ ] Подготовить гайдлайны по бренду (структура ассетов, нейминг, превью) и обновлять их по мере изменений

---

### Пользовательские истории (минимальный набор)
- [ ] Как пользователь, я могу пройти онбординг и получить персональные калории/БЖУ
- [ ] Как пользователь, я могу внести прием пищи вручную, указать блюда/ингредиенты и порции
- [ ] Как пользователь, я могу отправить фото блюда и подтвердить распознанный состав
- [ ] Как пользователь, я вижу прогресс дня и рекомендации, чтобы уложиться в бюджет
- [ ] Как пользователь, я могу спросить у AI-диетолога, как улучшить мой рацион
- [ ] Как пользователь, я могу открыть Web App внутри Telegram для удобного ввода и просмотра аналитики
- [ ] Как пользователь, я могу получать персональные текстовые сообщения и короткие видео с рекомендациями

### Критерий «полноценного работающего продукта» (без тестов/деплоя)
- [ ] Стабильные основные сценарии: онбординг → расчет бюджетов → ввод пищи (текст/фото) → сводки/отчеты → AI-подсказки
- [ ] Данные корректно сохраняются, редактируются и экспортируются
- [ ] Расчеты калорий и БЖУ соответствуют выбранным формулам и целям
- [ ] При ошибках провайдеров предусмотрены фолбэки и понятные сообщения
- [ ] Рассылка контента работает: тексты/медиа/видео с персонализацией и учётом настроек пользователя (частота/формат)


