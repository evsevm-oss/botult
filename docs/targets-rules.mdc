## Правила расчёта целевых калорий и белка (targets-rules)

Версия: 1.0

Назначение: единые правила для выдачи целевых суточных калорий и белка, когда пользователь не знает «идеальных» цифр. Блок опирается на уже принятые формулы и диапазоны: BMR по Katch–McArdle при известной ЖМТ, оценка BF% по окружностям, TDEE по уровням активности, диапазоны дефицита/профицита и белка из внутреннего консенсуса.

См. также: `docs/metodology-fat-percents.mdc`, `docs/dietology-recommendations.mdc`, реализацию базовых формул в `domain/calculations.py`.

### Входные данные
- вес `weight_kg`
- пол `sex` (male, female, other)
- рост `height_cm`
- обхват талии `waist_cm`
- обхват шеи `neck_cm`
- доля жира `bf_percent` (если неизвестна, оцениваем из окружностей)

Дополнительно (если доступно): уровень активности `activity_level` (`sedentary`, `light`, `moderate`, `active`, `very_high`). По умолчанию используем `moderate`.

### Базовые расчёты
1) Оценка BF% (если не введён напрямую)
   - Мужчины (US Navy): \(BF\% = 86.010\cdot\log_{10}(waist_{in} - neck_{in}) - 70.041\cdot\log_{10}(height_{in}) + 36.76\)
   - Женщины (YMCA без бедра): \(BF\% = \frac{(waist_{in}\cdot 4.15) - (weight_{lb}\cdot 0.082) - 76.76}{weight_{lb}} \cdot 100\)
   - Конверсии и детали — см. `docs/metodology-fat-percents.mdc`. Результат ограничиваем: 3–65%.
   - Для `sex = other`: расчёт BF% по окружностям не нейтрален к полу, поэтому предпочтительно принимать прямой ввод BF%. При его отсутствии — использовать нейтральные эвристики или запросить уточнение.

2) Тощая масса (ЖМТ, LBM) и BMR
   - \(LBM_{kg} = weight_{kg} \cdot (1 - BF\%/100)\)
   - BMR (Katch–McArdle): \(BMR = 370 + 21.6\cdot LBM_{kg}\)
   - При отсутствующей/ненадёжной LBM допускается Mifflin–St Jeor (требует возраста); предпочтение — Katch–McArdle, т.к. не требует возраста при известном BF%.

3) TDEE по активности
   - Множители: `sedentary`=1.2, `light`=1.375, `moderate`=1.55, `active`=1.725, `very_high`=1.9.
   - По умолчанию: `moderate` (1.55), с последующей калибровкой по тренду массы.
   - \(TDEE = BMR \times multiplier\)

4) Округление выдачи
   - Калории округлять до 10 ккал.
   - Белок — до 1 г.

### Цели и целевые значения

Обозначения: \(kcal_{tgt}\) — целевые калории; \(P_{min}\) — минимальный белок в граммах; все значения до округления подчиняются ограничениям безопасности.

— Снижение веса (дефицит калорий)
- Дефицит: 10–25% от TDEE (по умолчанию 15%).
- Формула калорий: \(kcal_{tgt} = TDEE \cdot (1 - deficit)\). Выдаём как «не более» этой величины.
- Минимальный белок: \(P_{min} = 1.8\,g \cdot kg^{-1}\cdot LBM\). Допускается повышать до 2.2 при низком BF%/высокой нагрузке.
- Ограничения безопасности (применяются до округления):
  - Нижние калорийные пределы без меднаблюдения: ≥1200 ккал/сут (женщины) и ≥1500 ккал/сут (мужчины).
  - Стремиться не опускать энергодоступность ниже ≈30 ккал/кг LBM (приближённо).

— Поддержание веса
- Формула калорий: \(kcal_{tgt} = TDEE\) (цель — вес не меняется). Выдаём как «ориентир/не более».
- Минимальный белок: \(P_{min} = 1.6\,g \cdot kg^{-1}\cdot LBM\) (диапазон 1.4–2.0 допустим по контексту активности/возраста).

— Рост мышечной массы
- Профицит: 5–15% от TDEE (по умолчанию 10%).
- Формула калорий (нижняя планка): \(kcal_{tgt\_min} = TDEE \cdot (1 + surplus)\). Выдаём как «не менее».
- Минимальный белок: \(P_{min} = 1.8\,g \cdot kg^{-1}\cdot LBM\) (часто целесообразно 2.0–2.2 при высоких объёмах силовых).

### Резервы и «заглушки» при отсутствующих данных
- Если BF% и окружности недоступны, временно считаем белок от массы тела:
  - Снижение: ≥1.6 г/кг массы.
  - Поддержание: ≥1.4 г/кг массы.
  - Набор: ≥1.6–1.8 г/кг массы.
- При появлении BF%/окружностей пересчитать LBM и обновить белковую планку.

### Примеры расчёта

Пример A (мужчина): height=180 см, weight=80 кг, waist=85 см, neck=40 см, activity=moderate
- Оценка BF% ≈ 15.4% (см. методологию) → LBM ≈ 67.7 кг
- BMR ≈ 370 + 21.6×67.7 ≈ 1830 ккал
- TDEE ≈ 1830×1.55 ≈ 2840 ккал
- Снижение (−15%): kcal_tgt ≈ 2840×0.85 ≈ 2410 ккал → «не более 2410 ккал»; P_min ≈ 1.8×67.7 ≈ 122 г
- Поддержание: kcal_tgt ≈ 2840 ккал; P_min ≈ 1.6×67.7 ≈ 108 г
- Набор (+10%): kcal_tgt_min ≈ 2840×1.10 ≈ 3120 ккал → «не менее 3120 ккал»; P_min ≈ 122 г

Пример B (женщина): height=165 см, weight=60 кг, waist=70 см, activity=moderate
- Оценка BF% ≈ 20.3% → LBM ≈ 47.8 кг
- BMR ≈ 370 + 21.6×47.8 ≈ 1400 ккал
- TDEE ≈ 1400×1.55 ≈ 2170 ккал
- Снижение (−15%): kcal_tgt ≈ 2170×0.85 ≈ 1850 ккал → «не более 1850 ккал»; P_min ≈ 1.8×47.8 ≈ 86 г
- Поддержание: kcal_tgt ≈ 2170 ккал; P_min ≈ 1.6×47.8 ≈ 77 г
- Набор (+10%): kcal_tgt_min ≈ 2170×1.10 ≈ 2390 ккал → «не менее 2390 ккал»; P_min ≈ 86 г

Все конечные значения округлять: калории до 10, белок до 1 г.

### Примечания по внедрению
- В коде использовать существующие функции: `estimate_lbm_from_bf`, `bmr_katch_mcardle`, `tdee_from_activity`, `target_kcal_from_goal` и `distribute_macros` (для единообразия расчётов и ограничений).
- Протеиновую планку считывать из параметра `protein_per_kg_lbm` с целевым минимумом по цели и жестким ограничением [1.4, 2.4] г/кг LBM.
- При смене фазы (снижение → поддержание → набор) применять 2–6 недель стабилизации на уровне TDEE по рекомендациям.

